---
title: "Government Crisis in Italy"
author: "Ruzza Tomas, Sioli Lorenzo, Destro Nicola"
date: "2/7/2021"
output: html_document
---

We started by creating a specific script for setting up our software for the analysis, choosing and loading the required packages
```{r  message=FALSE, warning=FALSE}

#dir.create("dataset")
#dir.create("scripts")
#dir.create("figs")
#dir.create("report")
#dir.create("docs")
#dir.create("download")
library(tidyverse)
library(tidytext)
library(rio)
library(stringr)
library(xml2)
library(httr)
library(RCurl)
library(quanteda)
library(rtweet)
library(rvest)
library(lubridate)
library(scales)
library(stargazer)
library(kableExtra)
library(plotly)
```

We imported the "parl_gov" dataset and filtered it for observations about Italy.
We needed to add variables to this base dataframe and looked for them on Wikipedia, we scraped the Wikipedia pages for each and every one of the Italian republican governments with a for-loop.
This allowed us to gather a second dataframe with the referral links and the dimission dates of the cabinets.
We then merged the scraped df with our original one.
We scraped another webpage from Wikipedia containing a useful table with all the infos about the exact lengths of the Italian govs, and merged it too in our main df.
We performed multiple operations to manage and clean our data and ended up with "Italy", our final polished dataset.
```{r,  include=FALSE}
cabinet_dataset <- rio::import(here::here("dataset/", "view_cabinet.csv"))  #importing dataset

cabinet_ita <- filter(cabinet_dataset,
                      country_name == "Italy") #filtering dataset

#here::here("dataset", rio::export(cabinet_ita, "Gov_Ita.csv"))


#For building -----

base_url <-"https://it.wikipedia.org"
url2 <- "https://it.wikipedia.org/wiki/Governo_Parri"

#Getting first link

name_gov2 <- read_html(url2) %>% 
  html_node("span+ span a") %>% 
  html_attr("href")
name_gov2
#Getting all links

government_list <- vector(mode = "list", length = 66) #empty vector  
#2 to 66 'cause we already have the first link which will be put in his position
#after the loop for praticity reasons

#for(i in 1:66){
#government_list[i] <- name_gov2 <- read_html(str_c(base_url,name_gov2)) %>% 
#            html_node("span+ span a") %>% 
#            html_attr("href")

#            Sys.sleep(1)
#}


#Wikipedia gave us links that aren't usable to download the html files.
#Let's build them and than download.

for(z in 1:66){
 government_list[[z]] <- paste0(base_url, government_list[[z]])
}


#for(y in 1:66){
#  download.file(government_list[[y]], destfile = here::here("download/", str_c("page", y, ".html")))
#  Sys.sleep(1)
#}

#To take the dates of resignations for each government we do the same we already did
#to get the links

resignations <- vector(mode = "list", length = 66)

for(it in 1:66){
resignations[it ]<- read_html(here::here("download/Wikipedia", str_c("page", it, ".html"))) %>% 
  html_node(".sinottico tr:nth-child(8) td") %>% 
  html_text()
}

end_gov <- tibble(government_list, resignations)
#here::here("dataset", rio::export(end_gov, "Resignations_date.csv"))

url_length<- "https://it.wikipedia.org/wiki/Governi_italiani_per_durata"

#download.file(url_length, destfile = here::here("download/", "GL.html"))

gov_length<-read_html(here::here("download/Wikipedia", "GL.html")) %>% html_nodes(xpath = '//*[@id="mw-content-text"]/div[1]/div[3]/table')%>%
  html_table(fill = TRUE)

gov_length_df<-gov_length[[1]]

#download.file("https://www.corriere.it/dataroom-milena-gabanelli/crisi-governo-66-esecutivi-75-anni-quanto-ci-costa-instabilita-politica-renzi-conte/4335b5f2-58d5-11eb-9753-e0ea6e647f4a-va.shtml", destfile = "report_corriere.html")

#Removing errors and merging by ID

ita_gov<-subset(cabinet_ita, prime_minister %in% 1)
ita_govs<-subset(ita_gov, cabinet_name != "Dini II" & cabinet_name != "Letta II")

ita_govs<-tibble::rowid_to_column(ita_govs, "ID")
end_gov<-tibble::rowid_to_column(end_gov, "ID")

ita_governments<- merge(ita_govs,end_gov,by="ID") 

#removing useless variables

govs_ita<- subset(ita_governments, select = -c(country_name_short, country_name, party_name_english,country_id, election_id, cabinet_id, previous_cabinet_id, party_id,left_right, party_name_short, cabinet_party,prime_minister))

#managment dataframe: gov_lenght_ita
#playing whith dates

str(gov_length_df) #chech format variables

annoying <- c(gov_length_df$`Data di termine[3]`)
annoying
gov_length_df$`Data di termine[3]` <- as.Date(annoying, format =  "%d %B %Y")

gov_length_df <- subset(gov_length_df, select = -c(N.))

gov_length_df <- gov_length_df[order(gov_length_df$`Data di termine[3]`), ]

gov_length_df<-tibble::rowid_to_column(gov_length_df, "ID")

data_frame <- merge(govs_ita,gov_length_df,by="ID") 

data_frame <- subset(data_frame, select = -c(Governo, government_list, resignations, `Periodo di carica`))

data_frame[data_frame$ID == 50, "caretaker"] <- 1 #Ciampi was a technical gov. 

data_frame<-rename(data_frame, tot_days =`Giorni in carica[1]`, real_days = `Giorni effettivi[2]`,  end_date = `Data di termine[3]`)

col_order <- c("ID", "cabinet_name", "start_date",
               "end_date", "tot_days", "real_days", "party_name", "election_date", "seats", "election_seats_total", "caretaker")

italy<- data_frame[, col_order]
italy

italy[italy$ID == 66, "tot_days"] <- 517
is.numeric(italy$tot_days)
italy$tot_days <- as.numeric(italy$tot_days)


italy[italy$ID == 7 |italy$ID == 9 | italy$ID ==27|italy$ID ==35|italy$ID ==44, "real_days"] <- c(12,11,8,10,10)
is.numeric(italy$real_days)
italy$real_days <- as.numeric(italy$real_days)

italy$start_date <- as.Date(italy$start_date)
italy$election_date <- as.Date(italy$election_date)

str(italy)

italy$crisis_days <- italy$tot_days - italy$real_days

col_order <- c("ID", "cabinet_name", "start_date",
               "end_date", "tot_days", "real_days","crisis_days", "party_name", "election_date", "seats", "election_seats_total", "caretaker")

italy<- italy[, col_order]
italy

italy$outcomes <- 0
italy[italy$ID == 1, "outcomes"]<-"First Gov"

italy[italy$ID == 2 | italy$ID == 5 | italy$ID == 6 | italy$ID == 8 | italy$ID == 9 | italy$ID == 11 | italy$ID == 15 | 
        italy$ID == 16 | italy$ID == 20 | italy$ID == 21 | italy$ID == 26 | italy$ID == 30 |italy$ID == 34 | italy$ID == 38 |
        italy$ID == 40 | italy$ID == 41 |italy$ID == 43 | italy$ID == 46 | italy$ID == 47 |italy$ID == 55 |italy$ID == 58 | italy$ID == 63 | 
        italy$ID == 64, "outcomes"] <- "Majority Confirmed"

italy[italy$ID == 3 | italy$ID == 10 | italy$ID == 12 | italy$ID == 14 | italy$ID == 17 | 
        italy$ID == 19 | italy$ID == 23 | italy$ID == 24 | italy$ID == 25 | italy$ID == 27 | italy$ID == 29 | italy$ID == 31 |
        italy$ID == 32 | italy$ID == 35 | italy$ID == 37 | italy$ID == 39 |italy$ID == 44 |italy$ID == 48 |
        italy$ID == 54 | italy$ID == 56 | italy$ID == 66, "outcomes"] <- "Majority Changed"

italy[italy$ID == 7 | italy$ID == 13 | italy$ID == 18 | italy$ID == 22 | italy$ID == 42 | 
        italy$ID == 49, "outcomes"] <- "End Legislature"

italy[italy$ID == 28 | italy$ID == 33 | italy$ID == 36 | italy$ID == 45 | italy$ID == 51 | 
        italy$ID == 53 | italy$ID == 57 | italy$ID == 59 | italy$ID == 60 | italy$ID == 62 |
        italy$ID == 65, "outcomes"] <- "Early Election"

italy[italy$ID == 50 | italy$ID == 52 | italy$ID == 61, "outcomes" ] <- "Technocratic Gov."

italy[italy$ID == 4, "outcomes"] <- "Constitutional Referendum"
```

We went on with our analysis starting from the visualization of our data.
First, we wanted compare the crisis time between each government and the averages and highlights of the Italian cabinets.
Our variables are "tot_days" which counts the total days of length of a given cabinet from the day of its oath to the oath of the next one.
"real_days", which counts the days of a cabinet from oath date to resignation date.
And "crisis_days" which counts the difference between "tot" and "real", and basically representing the crisis period of the executive.
We found out that, on average, Italian cabinets tend to last a little more than one year (376.8 days). This data would be even worse for the so called "Prima Repubblica" period (1946-1994), the average time of the subsequent governments is almost doubled (1994-today).
The record for the longest executive is currently 1412 (with only three crisis days) and it is held by the Berlusconi II cabinet; while the shortest is 22 days (with 11 crisis days) and it is held by the Fanfani I cabinet. 
Italy spent 2364 days in office for current affairs in total (and counting).



<div align="center">
```{r  results = "asis" }
stargazer(summarize(italy, crisis_days, tot_days, real_days), type = "html", nobs = FALSE, mean.sd = TRUE, median = TRUE, iqr = TRUE) 
```
</div>

we wanted to give an overview of the Italian republican history and its numerous governments and we plotted it in a time-line.
The line shows the sequence of the cabinets and the nature of their establishment: confirmation of the exiting majority, new majority, new elected legislature, early elections, or technocratic government. 

```{r echo= FALSE, message = FALSE, out.width='100%'}
#TIMELINE

outcomes_levels <- c("First Gov", "Majority Confirmed", "Majority Changed", "Constitutional Referendum", "Early Election", "End Legislature", "Technocratic Gov.")
outcomes_colors <- c("#0070C0", "#00ff00", "#C00000", "#FFC000", "#708090", "#ff7f50", "#000000")

italy$outcomes <- factor(italy$outcomes, levels=outcomes_levels, ordered=TRUE)

positions <- c(0.5, -0.5, 1.0, -1.0, 1.5, -1.5)
directions <- c(1, -1)

line_pos <- data.frame(
  "start_date"=unique(italy$start_date),
  "position"=rep(positions, length.out=length(unique(italy$start_date))),
  "direction"=rep(directions, length.out=length(unique(italy$start_date)))
)

ita <- merge(x=italy, y=line_pos, by= "start_date", all = TRUE)
ita <- ita[with(ita, order(start_date, outcomes)), ]

head(ita)



text_offset <- 0.05

ita$year_count <- ave(ita$start_date==ita$start_date, ita$start_date, FUN=cumsum)
ita$text_position <- (ita$year_count * text_offset * ita$direction) + ita$position
head(ita)

year_buffer <- 1

year_date_range <- seq(min(ita$start_date) - years(year_buffer), max(ita$start_date) + years(year_buffer), by='year')
year_format <- format(year_date_range, '%y')
year_df <- data.frame(year_date_range, year_format)

#PLOT

timeline_plot<-ggplot(ita,aes(x=start_date,y=0, col=outcomes, label= cabinet_name))
timeline_plot<-timeline_plot+labs(col="outcomes")
timeline_plot<-timeline_plot+scale_color_manual(values=outcomes_colors, labels=outcomes_levels, drop = FALSE)
timeline_plot<-timeline_plot+theme_classic()

# Plot horizontal black line for timeline
timeline_plot<-timeline_plot+geom_hline(yintercept=0, 
                                        color = "black", size=0.3)

# Plot vertical segment lines for milestones
timeline_plot<-timeline_plot+geom_segment(data=ita[ita$year_count == 1,], aes(y=position,yend=0,xend=start_date), color='black', size=0.2)

# Plot scatter points at zero and date
timeline_plot<-timeline_plot+geom_point(aes(y=0), size=3)

# Don't show axes, appropriately position legend
timeline_plot<-timeline_plot+theme(axis.line.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.title.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   axis.text.x =element_blank(),
                                   axis.ticks.x =element_blank(),
                                   axis.line.x =element_blank(),
                                   legend.position = "bottom"
)

# Show text for each year
timeline_plot<-timeline_plot+geom_text(data=year_df, aes(x=year_date_range,y=-0.1,label=year_format),size=2.5,vjust=0.5, color='black', angle=90)

# Show text for each cabinet
timeline_plot<-timeline_plot+geom_text(aes(y=text_position,label=cabinet_name),size=2.5)
#print plot
ggplotly(timeline_plot)

```

This pie-chart shows the proportions of such outcomes.
A confirmation of the exiting majority with a government reshuffle is the most common outcome of an Italian government crisis: basically the ministers change but the majority coalition remains unchanged. 
Similarly often a new majority is crafted without calling for new elections: a new government coalition within the same legislature, this is what recently happened in 2019 with the shift form the first and second iteration of the "Conte" cabinet.

The high instability of the italian majorities led too several early election turn, making this practice very common both in the "prima" and "seconda repubblica".
Three times in republican history a technocratic government establishment was necessary, with Dini in 1995 , Ciampi in 1993, and Monti in 2011 (soon to be four times).


```{r  echo=FALSE}
conta <- count(italy, outcomes) 
conta

#dev.off()

# Basic piechart
ggplot(conta, aes(x="", y=n, fill=outcomes)) +
  geom_bar(stat="identity", color="white") +
  coord_polar("y", start=0) +
  theme_void() # remove background, grid, numeric labels
```

In order to show the differences of the Italian governments we plotted the time-spans of the 66 executives.
The graph properly shows the behaviour of Italian republican democracy and its instability and tendency to short governments and legislatures (66 cabinets in 75 years).
There could be, however, a new pattern towards slightly longer executives started in the 90' with the "seconda repubblica", all of the spikes of our graph are in fact grouped to the right side ( circa 1994 to today).

```{r  echo=FALSE}
#Time line days.

time_line2 <- ggplot(italy, aes(x = start_date, y = real_days)) +
  geom_line(color = "orange") + 
  geom_point(color = "black") +
  scale_y_continuous() +
  ggtitle("Government duration during years")+
  ylab("Real days") +
  xlab("Date") + 
  theme_bw() 
ggplotly(time_line2)  

```

With such an high number of governments comes an almost equally great number of governments crisis; these periods spent "in office for current affairs" show great differences within one another.
We saw that the average crisis lasts 35 days, but Italy has reached peaks of 128 days without a proper government coalition.
However, most of the highest bars in our graph are in correspondence of new elections and consequents electoral campaigns, both for natural end of the legislature and for the call to early elections.

```{r  echo=FALSE}
#Crisis Days
g1 <- ggplot(italy, aes(x = ID, y = crisis_days)) +
    geom_bar(stat = "identity", fill = "darkblue") +
    scale_y_continuous() +
    ggtitle("Crisis days")+
    ylab("Days") +
    xlab("")+
    theme_bw()

points_to_label <- c("Dini I", "Monti", "Andreotti V", "Andreotti I", "Ciampi", "Gentiloni")

g2 <- g1 + 
  geom_text(aes(ID,  crisis_days, label = cabinet_name), data = italy[italy$cabinet_name %in% points_to_label, ]) 

ggplotly(g2)
```


```{r  echo=FALSE}

url3 <- "https://ejpr.onlinelibrary.wiley.com/doi/10.1111/1475-6765.12054"
download.file(url3, destfile = "technocracy_in_europe.html")

tech_table <- read_html(url3) %>% 
  html_node( xpath = "/html/body/div[2]/div/div[2]/main/div[1]/div/section[2]/div/div/div/div/article/div/div[1]/div[5]/article/section[2]/section[3]/div[2]/div[1]/table") %>% 
  html_table()
tech_table

tech_table2 <- read_html(url3) %>% 
  html_node( xpath = "/html/body/div[2]/div/div[2]/main/div[1]/div/section[2]/div/div/div/div/article/div/div[1]/div[5]/article/section[2]/section[5]/div/div[1]/table") %>% 
  html_table()
tech_table2
#here::here("dataset", rio::export(tech_table2, "Tech_Gov_Economics.csv"))

tech_table3 <- read_html(url3) %>% 
  html_node( xpath = "/html/body/div[2]/div/div[2]/main/div[1]/div/section[2]/div/div/div/div/article/div/div[1]/div[5]/article/section[2]/section[6]/div[2]/div[1]/table") %>% 
  html_table()
tech_table3

tech_tabl4 <- read_html(url3) %>%
  html_node( xpath = "/html/body/div[2]/div/div[2]/main/div[1]/div/section[2]/div/div/div/div/article/div/div[1]/div[5]/article/section[2]/section[7]/div/div[1]/table") %>%
  html_table()
tech_tabl4
#here::here("dataset", rio::export(tech_tabl4, "Percentage_EU_Tech_Gov.csv"))


tech_table <- subset(tech_table, select = -c(No.))
tech_table3 <- subset(tech_table3, select = -c(No.))

techn <- merge(tech_table, tech_table3, by = "Prime minister")

techn <- subset(techn, `Member State.x` != "Total")
techn <- subset(techn, select = -c(`Member State.x`) )

techn <-rename(techn, state = `Member State.y`,prime_minister =`Prime minister`, office_period = `Period in office`,  tot_days = `Days in office`,
                tec_economy_min = `Technocrat economy minister`, tech_percentage = `Percentage of technoc ministers`,
                gov_type =`Type of government` )

col_order <- c("state", "prime_minister", "gov_type",
               "tech_percentage", "tec_economy_min", 
               "office_period", "tot_days")

techn <- techn[, col_order]
techn

#here::here("dataset", rio::export(techn, "EU_Tech_Govs.csv"))


#deleting useless variables from enviroment
rm('ita_gov', 'ita_governments', 'ita_govs', 'resignations', 'gov_length', 'end_gov', 'cabinet_ita', 'cabinet_dataset', 'govs_ita', 'government_list', 'gov_length_df', 'data_frame')
rm(tech_table, tech_table3)

library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)


capmap<-read.csv(here::here ("dataset", "concap.csv"))
capmap<-dplyr::filter(capmap, capmap$ContinentName == "Europe")
capmap<- dplyr::rename(capmap, state = CountryName)

techmap<-merge(capmap, techn, by = "state")

#europe map-----

world <- ne_countries(scale = "medium", returnclass = "sf")
Europe <- world[which(world$continent == "Europe"),]
EU<-ggplot(Europe) +
  geom_sf() +
  coord_sf(xlim = c(-25,50), ylim = c(35,70), expand = FALSE)


N<-c(3,3,3,2,2,3,3,3,5,5,5,5,5,1,3,3,3,2,2,5,5,5,5,5)
N<-as.data.frame(N)
N<-tibble::rowid_to_column(N, "ID")
techmap<-tibble::rowid_to_column(techmap, "ID")
techmap<-merge(N,techmap, by= "ID")

Map1<-EU + geom_point(aes(x = CapitalLongitude, y = CapitalLatitude, label=state, label2=N, label3=tot_days), data = techmap, size = 2.5, color="red") + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) + ylab("") + xlab("")
ggplotly(Map1)

rm(concap, europe, view_cabinet, N, Map1, EU, capmap, Europe, world)


###################################################
#Caretaking triggers

#TECH COMPARISON

#caretakers reasons----

trigger_for_technocracy<- c("post-communism transition","post-communism transition", "global debt crisis","global debt crisis", "post-communism transition", "internal reasons", "internal reasons", "internal reasons", "internal reasons", "global debt crisis", "global debt crisis", "internal reasons", "internal reasons", "global debt crisis", "internal reasons", "internal reasons", "global debt crisis", "internal reasons", "internal reasons", "post-communism transition","post-communism transition","post-communism transition","post-communism transition","post-communism transition")
trigger_for_technocracy<-as.data.frame(trigger_for_technocracy)

techn<-arrange(techn,(state))

trigger_for_technocracy<-tibble::rowid_to_column(trigger_for_technocracy, "ID")
techn<-tibble::rowid_to_column(techn, "ID")
techn_comp<-merge(trigger_for_technocracy, techn, by="ID")

contaplot <- trigger_for_technocracy %>%
  group_by(trigger_for_technocracy) %>%
  summarise(count=n())

cols <- c("internal reasons"="gold1","post-communism transition"="firebrick2", "global debt crisis"="dodgerblue2")

plottacont <- ggplot(contaplot, aes(x=reorder(trigger_for_technocracy,-count),y=count, fill = trigger_for_technocracy)) +  
  geom_bar(stat = "identity") +
  xlab(" ") +
  ylab(" ") +
  ggtitle("Caretaking triggers") +
  scale_fill_manual(values = cols)

ggplotly(plottacont)

```


